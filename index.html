<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Birim Fiyatlar — Arama</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --hover:#f3f4f6;
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:var(--bg);
    }
    .app{
      display:flex;
      height:100vh;
      gap:12px;
      padding:12px;
    }
    .panel{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    /* Left: folders */
    .sidebar{width:320px}
    .sideHeader{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
    }
    .brand{
      font-weight:800;
      letter-spacing:.2px;
      margin:0;
      font-size:16px;
    }
    .hint{
      margin:6px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .tree{
      padding:8px;
      overflow:auto;
    }
    .treeItem{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
    }
    .treeItem:hover{background:var(--hover)}
    .treeItem.active{
      background:rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.18);
    }
    .treeIcon{
      width:18px;height:18px; flex:0 0 18px;
      color:var(--muted);
    }
    .treeLabel{
      font-size:13px;
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
    }
    .treeMeta{
      color:var(--muted);
      font-size:12px;
      padding-left:28px;
      margin-top:-6px;
      padding-bottom:6px;
    }
    .children{margin-left:18px; border-left:1px dashed var(--line); padding-left:10px; display:none}
    .children.open{display:block}
    .chev{
      width:16px;height:16px; flex:0 0 16px;
      color:var(--muted);
      transform:rotate(0deg);
      transition:transform .12s ease;
    }
    .chev.open{transform:rotate(90deg)}
    .spacer{height:8px}
    /* Middle: list */
    .main{flex:1}
    .topbar{
      padding:12px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .searchWrap{
      flex:1;
      min-width:220px;
      display:flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      background:#fff;
    }
    .searchWrap:focus-within{border-color:rgba(37,99,235,.35); box-shadow:0 0 0 4px rgba(37,99,235,.10)}
    .searchIcon{width:18px;height:18px;color:var(--muted); flex:0 0 18px}
    #q{
      border:0; outline:0; width:100%;
      font-size:14px;
    }
    .pill{
      border:1px solid var(--line);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      color:var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill:hover{background:var(--hover)}
    .pill select{
      border:0; outline:0; font-size:13px; background:transparent;
      cursor:pointer;
    }
    .crumbs{
      padding:0 12px 12px;
      color:var(--muted);
      font-size:12px;
      border-bottom:1px solid var(--line);
    }
    .crumbs b{color:var(--text)}
    .list{
      overflow:auto;
      padding:6px;
    }
    .row{
      border-radius:14px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      cursor:pointer;
      border:1px solid transparent;
    }
    .row:hover{background:var(--hover)}
    .row.active{
      background:rgba(37,99,235,.08);
      border-color:rgba(37,99,235,.16);
    }
    .fileIcon{
      width:20px;height:20px; flex:0 0 20px;
      color:var(--muted);
      margin-top:2px;
    }
    .rowMain{min-width:0; flex:1}
    .rowTitle{
      display:flex;
      gap:8px;
      align-items:baseline;
      min-width:0;
    }
    .art{
      font-family:var(--mono);
      font-weight:700;
      font-size:13px;
      color:var(--text);
      padding:2px 8px;
      border-radius:999px;
      background:#f3f4f6;
      border:1px solid var(--line);
      flex:0 0 auto;
    }
    .desc{
      font-size:14px;
      font-weight:650;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      flex:1;
    }
    .rowSub{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .priceTag{
      flex:0 0 auto;
      text-align:right;
      margin-left:auto;
      padding-left:8px;
    }
    .price{
      font-weight:800;
      font-size:14px;
      letter-spacing:.1px;
    }
    .um{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }
    /* Right: details */
    .detail{width:420px}
    .detailHeader{
      padding:14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .detailTitle{
      margin:0;
      font-size:14px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .badge{
      font-family:var(--mono);
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      white-space:nowrap;
      height:fit-content;
    }
    .detailBody{
      padding:14px;
      overflow:auto;
    }
    .bigDesc{
      margin:8px 0 0;
      font-size:16px;
      font-weight:800;
      line-height:1.25;
    }
    .kv{
      margin-top:14px;
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px 12px;
      align-items:start;
    }
    .k{color:var(--muted); font-size:12px; padding-top:3px}
    .v{font-size:13px; line-height:1.35; word-break:break-word}
    .copyRow{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary{
      background:var(--accent);
      color:#fff;
      border-color:rgba(0,0,0,0);
    }
    .btn.primary:hover{background:var(--accent2)}
    .btn:hover{background:var(--hover)}
    .btn.primary:hover{background:var(--accent2)}
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      box-shadow:0 18px 40px rgba(0,0,0,.22);
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
    .empty{
      padding:30px 18px;
      text-align:center;
      color:var(--muted);
      font-size:13px;
    }
    /* Responsive */
    @media (max-width: 1100px){
      .detail{display:none}
    }
    @media (max-width: 820px){
      .sidebar{display:none}
      .app{padding:10px}
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="panel sidebar">
      <div class="sideHeader">
        <p class="brand">Birim Fiyatlar</p>
        <p class="hint">Dropbox tarzı menü + arama. Soldan seri/kategori seç ya da üstte arat.</p>
      </div>
      <div id="tree" class="tree"></div>
    </aside>

    <main class="panel main">
      <div class="topbar">
        <div class="searchWrap" title="Arama: ART, description, UM, série, catégorie">
          <svg class="searchIcon" viewBox="0 0 24 24" fill="none"><path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2"/><path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="q" placeholder="Ara… (örn: A1, beton, ankraj, m3)" autocomplete="off" />
        </div>

        <div class="pill" title="Para birimi affichée">
          <span>Para birimi</span>
          <select id="currency">
            <option value="dzd">DZD</option>
            <option value="euro">EUR</option>
            <option value="dzd_eqv">DZD (Eqv)</option>
          </select>
        </div>

        <div class="pill" title="Sırala la liste">
          <span>Sırala</span>
          <select id="sort">
            <option value="art">ART</option>
            <option value="price_desc">Prix ↓</option>
            <option value="price_asc">Prix ↑</option>
          </select>
        </div>

        <button class="pill" id="clear" title="Effacer la recherche et revenir au menu">Sıfırla</button>
      </div>

      <div class="crumbs" id="crumbs">Yükleniyor…</div>
      <div class="list" id="list"></div>
    </main>

    <aside class="panel detail" id="detail">
      <div class="detailHeader">
        <div>
          <p class="detailTitle">Detay</p>
          <p class="hint" style="margin:6px 0 0">Soldan bir kalem seç.</p>
        </div>
        <span class="badge" id="badge">—</span>
      </div>
      <div class="detailBody" id="detailBody">
        <div class="empty">Seçili kalem yok.</div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast">Kopyalandı ✅</div>

<script>
  const $ = (s)=>document.querySelector(s);
  const treeEl = $("#tree");
  const listEl = $("#list");
  const crumbsEl = $("#crumbs");
  const detailBody = $("#detailBody");
  const badgeEl = $("#badge");
  const toastEl = $("#toast");

  const state = {
    all: [],
    tree: {},
    seriesOpen: new Set(),
    series: null,
    category: null,
    selectedKey: null,
    q: "",
    currency: "dzd",
    sort: "art",
  };

  function norm(str){
    return (str ?? "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g,"");
  }

  function fmt(num){
    if (num === null || num === undefined || Number.isNaN(num)) return "—";
    const n = Number(num);
    // large numbers: keep grouped, 2 decimals max (but hide .00)
    return new Intl.NumberFormat("fr-FR", { maximumFractionDigits: 2 }).format(n);
  }

  function toast(msg="Kopyalandı ✅"){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("show"), 1200);
  }

  function buildTree(){
    const t = {};
    for (const it of state.all){
      const s = it.series;
      const c = it.category || "Sans catégorie";
      t[s] ??= {};
      t[s][c] ??= [];
      t[s][c].push(it);
    }
    state.tree = t;
  }

  function countForSeries(series){
    const cats = state.tree[series] || {};
    let n=0;
    for (const c in cats) n += cats[c].length;
    return n;
  }

  function iconFolder(){
    return `<svg class="treeIcon" viewBox="0 0 24 24" fill="none">
      <path d="M3 7.5A2.5 2.5 0 0 1 5.5 5h4.2a2.5 2.5 0 0 1 1.7.7l1.1 1.0c.5.5 1.2.8 1.9.8H18.5A2.5 2.5 0 0 1 21 10v7.5A2.5 2.5 0 0 1 18.5 20h-13A2.5 2.5 0 0 1 3 17.5V7.5Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
    </svg>`;
  }
  function iconFile(){
    return `<svg class="fileIcon" viewBox="0 0 24 24" fill="none">
      <path d="M7 3h7l3 3v15a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
      <path d="M14 3v4a2 2 0 0 0 2 2h4" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
    </svg>`;
  }

  function renderTree(){
    const seriesList = Object.keys(state.tree);
    let html = "";

    const allActive = state.series === null && state.category === null && !state.q;
    html += `
      <div class="treeItem ${allActive ? "active":""}" data-action="all">
        ${iconFolder()}
        <div class="treeLabel">Tümü</div>
        <div class="treeMeta"></div>
      </div>
      <div class="spacer"></div>
    `;

    for (const s of seriesList){
      const isActiveSeries = state.series === s && state.category === null && !state.q;
      const isOpen = state.seriesOpen.has(s);
      const n = countForSeries(s);

      html += `
        <div class="treeItem ${isActiveSeries ? "active":""}" data-action="series" data-series="${encodeURIComponent(s)}">
          <svg class="chev ${isOpen ? "open":""}" viewBox="0 0 24 24" fill="none">
            <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          ${iconFolder()}
          <div class="treeLabel" title="${s.replaceAll('"','&quot;')}">${s}</div>
        </div>
        <div class="treeMeta">${n} kalem</div>
        <div class="children ${isOpen ? "open":""}" data-children="${encodeURIComponent(s)}">
      `;

      const cats = Object.keys(state.tree[s] || {}).sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
      for (const c of cats){
        const activeCat = state.series === s && state.category === c && !state.q;
        const cnt = state.tree[s][c].length;
        html += `
          <div class="treeItem ${activeCat ? "active":""}" data-action="cat" data-series="${encodeURIComponent(s)}" data-cat="${encodeURIComponent(c)}" style="padding-left:8px">
            ${iconFolder()}
            <div class="treeLabel" title="${c.replaceAll('"','&quot;')}">${c}</div>
          </div>
          <div class="treeMeta">${cnt} kalem</div>
        `;
      }
      html += `</div><div class="spacer"></div>`;
    }

    treeEl.innerHTML = html;

    treeEl.querySelectorAll(".treeItem").forEach(el=>{
      el.addEventListener("click", (e)=>{
        const action = el.dataset.action;
        if (action==="all"){
          state.series = null; state.category = null; state.q = "";
          $("#q").value = "";
          renderAll();
          return;
        }
        if (action==="series"){
          const s = decodeURIComponent(el.dataset.series);
          // click on chevron zone toggles open, but also selects the series
          if (state.seriesOpen.has(s)) state.seriesOpen.delete(s);
          else state.seriesOpen.add(s);
          state.series = s; state.category = null; state.q = "";
          $("#q").value = "";
          renderAll();
          return;
        }
        if (action==="cat"){
          const s = decodeURIComponent(el.dataset.series);
          const c = decodeURIComponent(el.dataset.cat);
          state.seriesOpen.add(s);
          state.series = s; state.category = c; state.q = "";
          $("#q").value = "";
          renderAll();
          return;
        }
      });
    });
  }

  function itemKey(it){ return `${it.art}||${it.series}||${it.category||""}`; }

  function matches(it, qn){
    const hay = [
      it.art, it.description, it.um, it.series, it.category
    ].map(norm).join(" ");
    return hay.includes(qn);
  }

  function getVisibleItems(){
    let items;
    if (state.q){
      const qn = norm(state.q.trim());
      items = state.all.filter(it => matches(it, qn));
    } else if (state.series && state.category){
      items = (state.tree[state.series]?.[state.category] || []);
    } else if (state.series){
      // all items in series
      const cats = state.tree[state.series] || {};
      items = Object.values(cats).flat();
    } else {
      items = state.all;
    }

    // sorting
    if (state.sort === "art"){
      items = [...items].sort((a,b)=> (a.art||"").localeCompare((b.art||""), "fr", {numeric:true, sensitivity:"base"}));
    } else if (state.sort === "price_desc" || state.sort === "price_asc"){
      const k = state.currency;
      items = [...items].sort((a,b)=>{
        const da = Number(a[k] ?? -Infinity);
        const db = Number(b[k] ?? -Infinity);
        return state.sort === "price_desc" ? (db-da) : (da-db);
      });
    }
    return items;
  }

  function crumbs(){
    if (state.q){
      return `Arama: <b>${escapeHtml(state.q)}</b>`;
    }
    if (state.series && state.category){
      return `<b>${escapeHtml(state.series)}</b>  ›  ${escapeHtml(state.category)}`;
    }
    if (state.series){
      return `<b>${escapeHtml(state.series)}</b>`;
    }
    return `Tümü`;
  }

  function escapeHtml(s){
    return (s??"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function priceText(it){
    const k = state.currency;
    const label = k==="dzd" ? "DZD" : (k==="euro" ? "EUR" : "DZD Eqv");
    return `${fmt(it[k])} ${label}`;
  }

  function renderList(){
    const items = getVisibleItems();
    crumbsEl.innerHTML = `${crumbs()} <span style="color:#9ca3af">— ${items.length} sonuç</span>`;

    if (!items.length){
      listEl.innerHTML = `<div class="empty">Sonuç yok. Başka bir kelime dene (örn: beton, ankraj, m3, A1…).</div>`;
      // clear details if selected not in view
      return;
    }

    const rows = items.map(it=>{
      const key = itemKey(it);
      const active = state.selectedKey === key;
      const sub = `${it.um ? "UM: "+escapeHtml(it.um) : "UM: —"} • ${escapeHtml(it.category||"Sans catégorie")} • ${escapeHtml(it.series)}`;
      return `
        <div class="row ${active ? "active":""}" data-key="${escapeHtml(key)}">
          ${iconFile()}
          <div class="rowMain">
            <div class="rowTitle">
              <span class="art">${escapeHtml(it.art)}</span>
              <span class="desc" title="${escapeHtml(it.description)}">${escapeHtml(it.description)}</span>
            </div>
            <div class="rowSub" title="${sub}">${sub}</div>
          </div>
          <div class="priceTag">
            <div class="price">${escapeHtml(priceText(it))}</div>
            <div class="um">${escapeHtml(it.um || "—")}</div>
          </div>
        </div>
      `;
    }).join("");

    listEl.innerHTML = rows;

    listEl.querySelectorAll(".row").forEach(el=>{
      el.addEventListener("click", ()=>{
        const key = el.dataset.key;
        const it = state.all.find(x => itemKey(x) === key);
        if (!it) return;
        state.selectedKey = key;
        renderList();        // to update highlight
        renderDetail(it);
      });
    });
  }

  function copyToClipboard(text){
    navigator.clipboard.writeText(text).then(()=>toast("Kopyalandı ✅")).catch(()=>toast("Kopyalanamadı"));
  }

  function renderDetail(it){
    badgeEl.textContent = it.art || "—";

    const price = priceText(it);
    const parts = [
      ["Série", it.series],
      ["Catégorie", it.category || "Sans catégorie"],
      ["UM", it.um || "—"],
      ["Prix (DZD)", it.dzd != null ? fmt(it.dzd) : "—"],
      ["Prix (EUR)", it.euro != null ? fmt(it.euro) : "—"],
      ["DZD (Eqv)", it.dzd_eqv != null ? fmt(it.dzd_eqv) : "—"],
    ];

    const kv = parts.map(([k,v])=>`
      <div class="k">${escapeHtml(k)}</div>
      <div class="v">${escapeHtml(v)}</div>
    `).join("");

    const oneLine = `${it.art} - ${it.description} | UM: ${it.um||"—"} | ${price}`;

    detailBody.innerHTML = `
      <div class="badge" style="display:inline-block">${escapeHtml(price)}</div>
      <div class="bigDesc">${escapeHtml(it.description)}</div>

      <div class="kv">${kv}</div>

      <div class="copyRow">
        <button class="btn primary" id="copy1">Satırı kopyala</button>
        <button class="btn" id="copy2">ART kopyala</button>
        <button class="btn" id="copy3">Fiyatı kopyala (${escapeHtml(state.currency)})</button>
      </div>

      <div style="margin-top:14px;color:var(--muted);font-size:12px;line-height:1.4">
        İpucu: <b>ART</b> (A1…), kelime (beton, ankraj…), <b>UM</b> (m3, ml…), seri veya kategori ile arayabilirsin.
      </div>
    `;

    $("#copy1").onclick = ()=>copyToClipboard(oneLine);
    $("#copy2").onclick = ()=>copyToClipboard(it.art || "");
    $("#copy3").onclick = ()=>copyToClipboard(String(it[state.currency] ?? ""));
  }

  function renderAll(){
    renderTree();
    renderList();
  }

  async function init(){
    crumbsEl.textContent = "Yükleniyor…";
    const res = await fetch("./pricing.json", {cache:"no-store"});
    state.all = await res.json();

    buildTree();

    // default open first series
    const firstSeries = Object.keys(state.tree)[0];
    if (firstSeries) state.seriesOpen.add(firstSeries);

    // initial view
    renderAll();

    // wire inputs
    $("#q").addEventListener("input", (e)=>{
      state.q = e.target.value || "";
      // when searching, remove folder selection highlight feel
      renderTree();
      renderList();
    });

    $("#currency").addEventListener("change", (e)=>{
      state.currency = e.target.value;
      renderList();
      // refresh detail (keep selection)
      const it = state.all.find(x => itemKey(x) === state.selectedKey);
      if (it) renderDetail(it);
    });

    $("#sort").addEventListener("change", (e)=>{
      state.sort = e.target.value;
      renderList();
    });

    $("#clear").addEventListener("click", ()=>{
      state.q = "";
      $("#q").value = "";
      state.series = null;
      state.category = null;
      state.selectedKey = null;
      badgeEl.textContent = "—";
      detailBody.innerHTML = `<div class="empty">Seçili kalem yok.</div>`;
      renderAll();
    });
  }

  init().catch(err=>{
    console.error(err);
    crumbsEl.textContent = "Hata: pricing.json yüklenemedi";
    listEl.innerHTML = `<div class="empty"><b>pricing.json</b>, <b>index.html</b> ile aynı klasörde olmalı.</div>`;
  });
</script>
</body>
</html>
